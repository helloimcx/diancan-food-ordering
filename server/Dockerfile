# æ”¹è¿›çš„åç«¯Dockerfile - å®¶åº­ç‚¹é¤ç³»ç»Ÿ
FROM node:18-alpine

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# åˆ›å»ºappç”¨æˆ·ï¼ˆå®‰å…¨æœ€ä½³å®è·µï¼‰
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodeuser -u 1001

# å¤åˆ¶package.jsonå’Œpackage-lock.json
COPY package*.json ./

# éªŒè¯package.jsonæ˜¯å¦å­˜åœ¨
RUN if [ ! -f package.json ]; then echo "âŒ package.json not found!"; exit 1; fi

# å®‰è£…ä¾èµ–
RUN npm install --production

# éªŒè¯npm installæ˜¯å¦æˆåŠŸ
RUN ls -la node_modules/ && echo "âœ… Dependencies installed"

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# éªŒè¯å…³é”®æ–‡ä»¶å­˜åœ¨
RUN echo "ğŸ” éªŒè¯å…³é”®æ–‡ä»¶:" && \
    if [ -f server.js ]; then echo "âœ… server.js exists"; else echo "âŒ server.js missing"; fi && \
    if [ -f database.js ]; then echo "âœ… database.js exists"; else echo "âŒ database.js missing"; fi && \
    if [ -f package.json ]; then echo "âœ… package.json exists"; else echo "âŒ package.json missing"; fi

# åˆ›å»ºå¿…è¦çš„ç›®å½•
RUN mkdir -p uploads && \
    chown -R nodeuser:nodejs /app

# æš´éœ²ç«¯å£
EXPOSE 3001

# åˆ‡æ¢åˆ°nodeuserç”¨æˆ·
USER nodeuser

# å¥åº·æ£€æŸ¥ï¼ˆä½¿ç”¨nodeè€Œä¸æ˜¯curlï¼‰
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD node -e "require('http').get('http://localhost:3001/api/foods', (res) => {process.exit(res.statusCode === 200 ? 0 : 1)}).on('error', () => process.exit(1))"

# å¯åŠ¨åº”ç”¨
CMD ["npm", "start"]
