name: ç®€åŒ–éƒ¨ç½²åˆ°é˜¿é‡Œäº‘

on:
  push:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ç™»å½•GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: æ„å»ºå’Œæ¨é€Dockeré•œåƒ
      uses: docker/build-push-action@v6
      with:
        context: ./server
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:backend-latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: éªŒè¯é•œåƒæ¨é€
      run: |
        echo "ğŸ” éªŒè¯é•œåƒæ¨é€..."
        
        # ç­‰å¾…é•œåƒåŒæ­¥
        sleep 30
        
        # éªŒè¯é•œåƒå­˜åœ¨
        RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          "https://ghcr.io/v2/helloimcx/diancan-food-ordering/manifests/backend-latest")
        
        if [ "$RESPONSE" = "200" ]; then
          echo "âœ… é•œåƒæ¨é€æˆåŠŸ: backend-latest"
        else
          echo "âŒ é•œåƒæ¨é€å¤±è´¥ï¼ŒçŠ¶æ€ç : $RESPONSE"
          echo "ğŸ“‹ å¯ç”¨æ ‡ç­¾åˆ—è¡¨:"
          curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://ghcr.io/v2/helloimcx/diancan-food-ordering/tags/list" | jq '.'
          exit 1
        fi

    - name: æœåŠ¡å™¨éƒ¨ç½²ï¼ˆéœ€è¦SSHé…ç½®ï¼‰
      if: env.ALICLOUD_HOST != ''
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.ALICLOUD_HOST }}
        username: ${{ secrets.ALICLOUD_USER || 'root' }}
        key: ${{ secrets.ALICLOUD_PRIVATE_KEY }}
        port: ${{ secrets.ALICLOUD_PORT || 22 }}
        timeout: 30000
        script: |
          echo "ğŸ”„ å¼€å§‹æœåŠ¡å™¨éƒ¨ç½²..."
          
          # æ£€æŸ¥Dockeræ˜¯å¦å¯ç”¨
          if ! command -v docker &> /dev/null; then
            echo "âŒ Dockeræœªå®‰è£…ï¼Œå°è¯•å®‰è£…..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sh get-docker.sh
            systemctl start docker
          fi
          
          # æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
          echo "ğŸ” æ£€æŸ¥Dockeré•œåƒ..."
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:backend-latest || {
            echo "âŒ é•œåƒæ‹‰å–å¤±è´¥ï¼Œå°è¯•latestæ ‡ç­¾..."
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          }
          
          # åœæ­¢å¹¶åˆ é™¤ç°æœ‰å®¹å™¨
          echo "ğŸ›‘ åœæ­¢ç°æœ‰å®¹å™¨..."
          docker stop diancan-backend || true
          docker rm diancan-backend || true
          
          # å¯åŠ¨æ–°å®¹å™¨
          echo "ğŸš€ å¯åŠ¨æ–°å®¹å™¨..."
          docker run -d \
            --name diancan-backend \
            --restart unless-stopped \
            -p 3001:3001 \
            -e NODE_ENV=production \
            -v /opt/diancan-backend/data:/app \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:backend-latest || \
          docker run -d \
            --name diancan-backend \
            --restart unless-stopped \
            -p 3001:3001 \
            -e NODE_ENV=production \
            -v /opt/diancan-backend/data:/app \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 15
          
          # éªŒè¯éƒ¨ç½²
          echo "âœ… éªŒè¯éƒ¨ç½²çŠ¶æ€..."
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          # å¥åº·æ£€æŸ¥
          if curl -f http://localhost:3001/api/foods; then
            echo "âœ… æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
          else
            echo "âš ï¸ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œæ£€æŸ¥æ—¥å¿—:"
            docker logs diancan-backend --tail 20
            exit 1
          fi
          
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
